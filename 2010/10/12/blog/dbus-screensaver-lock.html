<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>DBUS for cross-machine screensaver locking and other cool things - Michael Mior</title>
    <link href='/styles.css' rel='stylesheet'>
    <link href='/img/favicon.ico' rel='icon'>
    <meta content='nanoc 3.6.5' name='generator'>
    <link href='/atom.xml' rel='alternate' title='Michael Mior' type='application/atom+xml'>
  </head>
  <body class='single-post'>
    <div class='hfeed' id='wrapper'>
      <div id='header'>
        <div id='blog-title'>
          <h1>
            <a href='/' rel='home' title='Michael Mior'>
              <span class='word-1'>Michael</span>
              <span class='word-2'>Mior</span>
            </a>
          </h1>
        </div>
        <div id='access'>
          <div class='skip-link'>
            <a href='#content' title='Skip navigation to the content'></a>
          </div>
          <div class='menu'>
            <ul class='sf-menu'>
              <li>
                <a href="/">Home</a>
              </li>
              <li>
                <a href="/about/">About</a>
              </li>
              <li>
                <a href="/contact/">Contact</a>
              </li>
              <li>
                <a href="/blog/archive/2012.html">Blog</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id='main'>
      <div id='container'>
        <div id='content'>
          <div class='post hentry'>
  <h1 class='entry-title'>DBUS for cross-machine screensaver locking and other cool things</h1>
  <div class='entry-content'>&#x000A;            <p>typically work with two computers on a regular&nbsp;basis.&#x000A;            When I bring my laptop into the office, that makes&nbsp;three.&#x000A;            I have a habit of locking my computer(s) when I step out, but it gets to be a pain when I have three machines running at&nbsp;once.&#x000A;            I decided that I wanted to be able to lock one machine, and have the rest follow&nbsp;suit.&#x000A;            I discovered that this is possible using <span class="caps">DBUS</span> since gnome-screensaver emits a signal whenever locking status is&nbsp;changed.&#x000A;            I turned to my trusty Python, and started hacking&nbsp;away.</p>&#x000A;            &#x000A;            <p>Without further ado, here is the&nbsp;code:</p>&#x000A;            &#x000A;            <div>&#x000A;            <div class="CodeRay">&#x000A;              <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#!/usr/bin/python</span>&#x000A;            <span class="line-numbers"> <a href="#n2" name="n2">2</a></span>&#x000A;            <span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">dbus</span>&#x000A;            <span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">dbus.mainloop.glib</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">DBusGMainLoop</span>&#x000A;            <span class="line-numbers"> <a href="#n5" name="n5">5</a></span><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">gobject</span>&#x000A;            <span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">os</span>&#x000A;            <span class="line-numbers"> <a href="#n7" name="n7">7</a></span>&#x000A;            <span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="color:#777"># Hosts which should be locked/unlocked</span>&#x000A;            <span class="line-numbers"> <a href="#n9" name="n9">9</a></span>hosts = [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">starks</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mmior-laptop</span><span style="color:#710">'</span></span>]&#x000A;            <span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#777"># Set to True to turn on displays of other</span>&#x000A;            <span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="color:#777"># hosts after unlocking</span>&#x000A;            <span class="line-numbers"><a href="#n12" name="n12">12</a></span>wake = <span style="color:#069">False</span>&#x000A;            <span class="line-numbers"><a href="#n13" name="n13">13</a></span>&#x000A;            <span class="line-numbers"><a href="#n14" name="n14">14</a></span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">toggle_lock</span>(x):&#x000A;            <span class="line-numbers"><a href="#n15" name="n15">15</a></span>  <span style="color:#080;font-weight:bold">if</span> x == <span style="color:#00D">0</span>:&#x000A;            <span class="line-numbers"><a href="#n16" name="n16">16</a></span>    <span style="color:#080;font-weight:bold">for</span> host <span style="color:#080;font-weight:bold">in</span> hosts:&#x000A;            <span class="line-numbers"><a href="#n17" name="n17">17</a></span>      os.system(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ssh </span><span style="color:#710">'</span></span> + host + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> export DISPLAY=:0; gnome-screensaver-command -d</span><span style="color:#710">'</span></span>)&#x000A;            <span class="line-numbers"><a href="#n18" name="n18">18</a></span>      <span style="color:#080;font-weight:bold">if</span> wake:&#x000A;            <span class="line-numbers"><a href="#n19" name="n19">19</a></span>        os.system(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ssh </span><span style="color:#710">'</span></span> + host + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> export DISPLAY=:0; xset dpms force on; gnome-screensaver-command -d</span><span style="color:#710">'</span></span>)&#x000A;            <span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>  <span style="color:#080;font-weight:bold">if</span> x == <span style="color:#00D">1</span>:&#x000A;            <span class="line-numbers"><a href="#n21" name="n21">21</a></span>    os.system(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">xset s activate</span><span style="color:#710">'</span></span>)&#x000A;            <span class="line-numbers"><a href="#n22" name="n22">22</a></span>    <span style="color:#080;font-weight:bold">for</span> host <span style="color:#080;font-weight:bold">in</span> hosts:&#x000A;            <span class="line-numbers"><a href="#n23" name="n23">23</a></span>      os.system(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ssh </span><span style="color:#710">'</span></span> + host + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> export DISPLAY=:0; xset dpms force off; gnome-screensaver-command -l</span><span style="color:#710">'</span></span>)&#x000A;            <span class="line-numbers"><a href="#n24" name="n24">24</a></span>&#x000A;            <span class="line-numbers"><a href="#n25" name="n25">25</a></span>DBusGMainLoop(set_as_default=<span style="color:#069">True</span>)&#x000A;            <span class="line-numbers"><a href="#n26" name="n26">26</a></span>&#x000A;            <span class="line-numbers"><a href="#n27" name="n27">27</a></span><span style="color:#777"># Connect to the session bus and</span>&#x000A;            <span class="line-numbers"><a href="#n28" name="n28">28</a></span><span style="color:#777"># install our signal handler</span>&#x000A;            <span class="line-numbers"><a href="#n29" name="n29">29</a></span>bus = dbus.SessionBus()&#x000A;            <span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>bus.add_signal_receiver(toggle_lock,&#x000A;            <span class="line-numbers"><a href="#n31" name="n31">31</a></span>  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ActiveChanged</span><span style="color:#710">'</span></span>,&#x000A;            <span class="line-numbers"><a href="#n32" name="n32">32</a></span>  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">org.gnome.ScreenSaver</span><span style="color:#710">'</span></span>,&#x000A;            <span class="line-numbers"><a href="#n33" name="n33">33</a></span>  path=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/org/gnome/ScreenSaver</span><span style="color:#710">'</span></span>)&#x000A;            <span class="line-numbers"><a href="#n34" name="n34">34</a></span>&#x000A;            <span class="line-numbers"><a href="#n35" name="n35">35</a></span><span style="color:#777"># Start the loop and wait for the signal</span>&#x000A;            <span class="line-numbers"><a href="#n36" name="n36">36</a></span>gobject.MainLoop().run()&#x000A;            <span class="line-numbers"><a href="#n37" name="n37">37</a></span>&#x000A;            <span class="line-numbers"><a href="#n38" name="n38">38</a></span><span style="color:#777"># Clean up by removing the signal handler</span>&#x000A;            <span class="line-numbers"><a href="#n39" name="n39">39</a></span>bus.remove_signal_receiver(toggle_lock,&#x000A;            <span class="line-numbers"><strong><a href="#n40" name="n40">40</a></strong></span>  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ActiveChanged</span><span style="color:#710">'</span></span>,&#x000A;            <span class="line-numbers"><a href="#n41" name="n41">41</a></span>  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">org.gnome.ScreenSaver</span><span style="color:#710">'</span></span>,&#x000A;            <span class="line-numbers"><a href="#n42" name="n42">42</a></span>  path=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/org/gnome/ScreenSaver</span><span style="color:#710">'</span></span>)&#x000A;            </pre></div>&#x000A;            </div>&#x000A;            </div>&#x000A;            &#x000A;            <p>This needs to be run as a daemon in the background to watch for the&nbsp;signal.&#x000A;            To use the script, just replace the hosts array with a list of hostnames you wish to&nbsp;lock/unlock.&#x000A;            The wake variable controls whether or not the screens of the other machines should be turned on when&nbsp;unlocked.&#x000A;            Of course you can add any actions you wish to take on&nbsp;lock/unlock.</p>&#x000A;            &#x000A;            <p>For more information, check out the <a href="http://dbus.freedesktop.org/doc/dbus-python/doc/tutorial.html">Python <span class="caps">DBUS</span> tutorial</a> or see how to use <a href="http://linux.die.net/man/1/dbus-monitor"><code>dbus-monitor</code></a> to watch for any signals going over the&nbsp;bus.</p>&#x000A;            &#x000A;            <p>If you want to poke around and see what <span class="caps">DBUS</span> interfaces various programs you have installed, check out the Debian package&nbsp;<code>qt4-dev-tools</code>.&#x000A;            It may be a little big since it requires installing lots of Qt libraries, but the included <code>qdbusviewer</code> tool is great for browsing signals and testing out message&nbsp;sending.</p>&#x000A;            &#x000A;            <p>If you run into any problems or come up with a cool use case, let me know in the&nbsp;comments!</p>&#x000A;</div>&#x000A;<div id='disqus_thread'>&#x000A;  <script>&#x000A;    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */&#x000A;    var disqus_shortname = 'michaelmior'; // required: replace example with your forum shortname&#x000A;    &#x000A;    /* * * DON'T EDIT BELOW THIS LINE * * */&#x000A;    (function() {&#x000A;      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;&#x000A;      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';&#x000A;      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);&#x000A;    })();&#x000A;  </script>&#x000A;  <noscript>&#x000A;    Please enable JavaScript to view the&#x000A;    <a href='https://disqus.com/?ref_noscript'>&#x000A;      comments powered by Disqus.&#x000A;    </a>&#x000A;  </noscript>&#x000A;  <a class='dsq-brlink' href='https://disqus.com'>&#x000A;    comments powered by&#x000A;    <span class='logo-disqus'>&#x000A;      Disqus&#x000A;    </span>&#x000A;  </a>&#x000A;</div>
</div>

        </div>
      </div>
    </div>
    <div id='footer'>
      <div id='siteinfo'>
        &copy; 2013 Michael Mior
      </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-45085128-1', 'mior.ca');
      ga('send', 'pageview');
    </script>
  </body>
</html>
