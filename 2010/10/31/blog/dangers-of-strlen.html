<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>The Dangers of strlen - Michael Mior</title>
    <link href='/styles.css' rel='stylesheet'>
    <link href='/img/favicon.ico' rel='icon'>
    <meta content='nanoc 3.6.4' name='generator'>
    <link href='/atom.xml' rel='alternate' title='Michael Mior' type='application/atom+xml'>
  </head>
  <body class='single-post'>
    <div class='hfeed' id='wrapper'>
      <div id='header'>
        <div id='blog-title'>
          <h1>
            <a href='/' rel='home' title='Michael Mior'>
              <span class='word-1'>Michael</span>
              <span class='word-2'>Mior</span>
            </a>
          </h1>
        </div>
        <div id='access'>
          <div class='skip-link'>
            <a href='#content' title='Skip navigation to the content'></a>
          </div>
          <div class='menu'>
            <ul class='sf-menu'>
              <li>
                <a href="/">Home</a>
              </li>
              <li>
                <a href="/about/">About</a>
              </li>
              <li>
                <a href="/contact/">Contact</a>
              </li>
              <li>
                <a href="/blog/archive/1.html">Blog</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id='main'>
      <div id='container'>
        <div id='content'>
          <div class='post hentry'>
            <h1 class='entry-title'>The Dangers of strlen</h1>
            <div class='entry-content'>&#x000A;  <p>I’ll keep this post brief, but I wanted to share something I just found about the C <code>strlen</code> function. It’s slow. It can make a big difference in program execution&nbsp;time.</p>&#x000A;  &#x000A;  <p>For example, I had a function in an external which consumes a string, so I call <code>strdup</code> each time around a loop to make sure I have a copy for the next&nbsp;iteration.</p>&#x000A;  &#x000A;  <p>In my case, the function I was calling already had the length of the string passed in as a parameter. This means <code>s2 = strdup(s1);</code> can be rewritten&nbsp;as</p>&#x000A;  &#x000A;  <div>&#x000A;  <div class="CodeRay">&#x000A;    <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>s2 = (<span style="color:#0a5;font-weight:bold">char</span>*) malloc(length);&#x000A;  <span class="line-numbers"><a href="#n2" name="n2">2</a></span>memcpy(s2, s1, length);&#x000A;  </pre></div>&#x000A;  </div>&#x000A;  </div>&#x000A;  &#x000A;  <p>Note that I used memcpy instead of&nbsp;strcpy.&#x000A;  Since we already have the length of the string, this also avoids the loop in strcpy which would be required to find the end of the&nbsp;string.&#x000A;  These kind of optimizations may seem like splitting hairs, but they can make a big difference in the overall runtime of your&nbsp;code.&#x000A;  For example, with the optimization shown above, I was able to reduce the runtime of a particular loop by around&nbsp;15%.</p>&#x000A;  &#x000A;  <p>Know of any other common functions with performance problems people may not be aware of? Share your inside info in the&nbsp;comments!</p>&#x000A;  &#x000A;  <p>Aside: While researching the performance of strlen, I came across this interesting forum post which provides an efficient strlen implementation from&nbsp;Knuth.</p>&#x000A;  &#x000A;  <h2 id="update-june-14-2012">Update: June 14,&nbsp;2012</h2>&#x000A;  &#x000A;  <p><span class="caps">GCC</span> <span class="caps">4.7.1</span> has an optimization to address this very issue. See the snippet below from the release&nbsp;notes.</p>&#x000A;  &#x000A;  <blockquote>&#x000A;    <p>A string length optimization pass has been added…The pass can e.g.&nbsp;optimize</p>&#x000A;  &#x000A;    <div>&#x000A;  <div class="CodeRay">&#x000A;    <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#0a5;font-weight:bold">char</span> *bar (<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a5;font-weight:bold">char</span> *a)&#x000A;  <span class="line-numbers"><a href="#n2" name="n2">2</a></span>{&#x000A;  <span class="line-numbers"><a href="#n3" name="n3">3</a></span>  size_t l = strlen (a) + <span style="color:#00D">2</span>;&#x000A;  <span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#0a5;font-weight:bold">char</span> *p = malloc (l); <span style="color:#080;font-weight:bold">if</span> (p == <span style="color:#069">NULL</span>) <span style="color:#080;font-weight:bold">return</span> p;&#x000A;  <span class="line-numbers"><a href="#n5" name="n5">5</a></span>  strcpy (p, a); strcat (p, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span>); <span style="color:#080;font-weight:bold">return</span> p;&#x000A;  <span class="line-numbers"><a href="#n6" name="n6">6</a></span>}&#x000A;  </pre></div>&#x000A;  </div>&#x000A;    </div>&#x000A;  &#x000A;    <p>into:</p>&#x000A;  &#x000A;    <div>&#x000A;  <div class="CodeRay">&#x000A;    <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#0a5;font-weight:bold">char</span> *bar (<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a5;font-weight:bold">char</span> *a)&#x000A;  <span class="line-numbers"><a href="#n2" name="n2">2</a></span>{&#x000A;  <span class="line-numbers"><a href="#n3" name="n3">3</a></span>  size_t tmp = strlen (a);&#x000A;  <span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#0a5;font-weight:bold">char</span> *p = malloc (tmp + <span style="color:#00D">2</span>); <span style="color:#080;font-weight:bold">if</span> (p == <span style="color:#069">NULL</span>) <span style="color:#080;font-weight:bold">return</span> p;&#x000A;  <span class="line-numbers"><a href="#n5" name="n5">5</a></span>  memcpy (p, a, tmp); memcpy (p + tmp, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span>, <span style="color:#00D">2</span>); <span style="color:#080;font-weight:bold">return</span> p;&#x000A;  <span class="line-numbers"><a href="#n6" name="n6">6</a></span>}&#x000A;  </pre></div>&#x000A;  </div>&#x000A;    </div>&#x000A;  </blockquote>&#x000A;</div>
            <div id='disqus_thread'></div>
            <script>
              /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
              var disqus_shortname = 'michaelmior'; // required: replace example with your forum shortname
              
              /* * * DON'T EDIT BELOW THIS LINE * * */
              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
            <noscript>
              Please enable JavaScript to view the
              <a href='https://disqus.com/?ref_noscript'>
                comments powered by Disqus.
              </a>
            </noscript>
            <a class='dsq-brlink' href='https://disqus.com'>
              comments powered by
              <span class='logo-disqus'>
                Disqus
              </span>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div id='footer'>
      <div id='siteinfo'>
        &copy; 2013 Michael Mior
      </div>
    </div>
  </body>
</html>
